version: 2.1
orbs:
  python: circleci/python@1.4.0
  gcp-cli: circle-ci/gcp@2.2.0
jobs:
  test-app:
    executor: python/default
    steps:
      - checkout
      - python/install-packages:
          args: pytest
          pkg-manager: pipenv      
      - run: 
          command: |
            pipenv run pytest --version
          name: Run tests
  deploy:
    steps:
      - gcp-cli/install_and_initialize_cli:
        executor: gcp-cli/default
      - run:
          command: |
            gcloud app deploy
workflows: 
  test-and-deploy:
    jobs:
      - test-app
      - deploy